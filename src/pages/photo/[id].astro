---
import Layout from '../../layouts/Layout.astro';
import pb from '../../lib/pb';

// Active le mode SSR pour cette page
export const prerender = false;

// Récupération du record depuis l'URL
const { id } = Astro.params;

let record = null;
try {
  record = await pb.collection('page_projet_photo').getOne(id);
} catch (error) {
  console.error('Erreur lors de la récupération du projet:', error);
  return Astro.redirect('/404');
}

if (!record) {
  return Astro.redirect('/404');
}

const heroUrl = pb.files.getUrl(record, record.hero);
const fondUrl = pb.files.getUrl(record, record.fond);
const imagefUrl = pb.files.getUrl(record, record.imagef);

// Groupe les photos par blocs de 6 (3x2)
const photoGroups = [];
if (record.photos && record.photos.length > 0) {
  for (let i = 0; i < record.photos.length; i += 6) {
    photoGroups.push(record.photos.slice(i, i + 6));
  }
}

// URLs pour la section collection 1
const fondcoll1Url = record.fondcoll1 ? pb.files.getUrl(record, record.fondcoll1) : null;
const hasColl1 = record.fondcoll1 && record.titlecoll1 && record.desccoll1 && record.seriecoll1;

// URLs pour la section collection 2
const fondcoll2Url = record.fondcoll2 ? pb.files.getUrl(record, record.fondcoll2) : null;
const hasColl2 = record.fondcoll2 && record.titlecoll2 && record.desccoll2 && record.seriecoll2;
---

<Layout title={record.title}>
  <div class="fixed top-0 left-0 w-full h-screen -z-10">
    <img 
      src={fondUrl} 
      alt="Background"
      class="w-full h-full object-cover"
    />
  </div>

  <div class="relative w-full h-screen">
    {/* Image hero en pleine largeur */}
    <img 
      src={heroUrl} 
      alt={record.title}
      class="w-full h-full object-cover"
    />
    
    {/* Texte en bas à gauche */}
    <div class="absolute bottom-5 left-5 p-8 text-white">
      <h1 class="text-[60px]" style="font-family: 'Climate Crisis', sans-serif;">{record.title}</h1>
      <h2 class="text-[32px] max-w-2xl" style="font-family: 'Climate Crisis', sans-serif;">{record.subtitle}</h2>
      <p class="text-[16px] max-w-2xl" style="font-family: 'Cal Sans', sans-serif;">{record.desc}</p>
    </div>
  </div>

  {/* Galerie de photos */}
  {photoGroups.length > 0 && (
    <div class="w-full px-20 py-16 space-y-20">
      {photoGroups.map((group, groupIndex) => (
        <>
          <div class="grid grid-cols-3 auto-rows-max gap-4">
            {group.map((photo) => {
              const photoUrl = pb.files.getUrl(record, photo);
              return (
                <div class="cursor-pointer gallery-item">
                  <img 
                    src={photoUrl} 
                    alt="Photo de galerie"
                    class="w-full h-64 object-cover hover:scale-105 hover:-rotate-5 hover:border-3 hover:border-white transition-transform duration-300"
                  />
                </div>
              );
            })}
          </div>

          {/* Section collection 1 après 2 parties (index 1) */}
          {groupIndex === 1 && hasColl1 && (
            <div class="w-screen relative left-1/2 right-1/2 -mx-[50vw]">
              {/* Fond avec texte */}
              <div class="relative w-full">
                <img 
                  src={fondcoll1Url} 
                  alt="Fond collection"
                  class="w-full h-auto object-cover -z-10 mb-40"
                />
                <div class="absolute top-10 left-10 text-white max-w-xl">
                  <h3 class="text-[32px] mb-4" style="font-family: 'Climate Crisis', sans-serif;">{record.titlecoll1}</h3>
                  <p class="text-[16px] whitespace-pre-wrap" style="font-family: 'Cal Sans', sans-serif;">{record.desccoll1}</p>
                </div>

                {/* Série d'images en lignes de 3 - superposée sur le fond */}
                {record.seriecoll1 && record.seriecoll1.length > 0 && (
                  <div class="absolute bottom-30 left-1/2 -translate-x-1/2 translate-y-1/2 w-full px-20">
                    <div class="grid grid-cols-3 gap-4 mb-20">
                      {record.seriecoll1.map((seriePhoto) => {
                        const serieUrl = pb.files.getUrl(record, seriePhoto);
                        return (
                          <div class="cursor-pointer gallery-item">
                            <img 
                              src={serieUrl} 
                              alt="Photo de série"
                              class="w-full h-64 object-cover hover:scale-105 transition-transform duration-300"
                            />
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Section collection 2 après 4 parties (index 3) */}
          {groupIndex === 3 && hasColl2 && (
            <div class="w-screen relative left-1/2 right-1/2 -mx-[50vw]">
              {/* Fond avec texte */}
              <div class="relative w-full">
                <img 
                  src={fondcoll2Url} 
                  alt="Fond collection 2"
                  class="w-full h-auto object-cover -z-10 mb-40"
                />
                <div class="absolute top-10 left-10 text-white max-w-xl">
                  <h3 class="text-[32px] mb-4" style="font-family: 'Climate Crisis', sans-serif;">{record.titlecoll2}</h3>
                  <p class="text-[16px] whitespace-pre-wrap" style="font-family: 'Cal Sans', sans-serif;">{record.desccoll2}</p>
                </div>

                {/* Série d'images en lignes de 3 - superposée sur le fond */}
                {record.seriecoll2 && record.seriecoll2.length > 0 && (
                  <div class="absolute bottom-30 left-1/2 -translate-x-1/2 translate-y-1/2 w-full px-20">
                    <div class="grid grid-cols-3 gap-4 mb-20">
                      {record.seriecoll2.map((seriePhoto) => {
                        const serieUrl = pb.files.getUrl(record, seriePhoto);
                        return (
                          <div class="cursor-pointer gallery-item hover:-rotate-30">
                            <img 
                              src={serieUrl} 
                              alt="Photo de série 2"
                              class="w-full h-64 object-cover hover:scale-105 transition-transform duration-300"
                            />
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}
        </>
      ))}
    </div>
  )}

  {/* Lightbox */}
  <div id="lightbox" class="hidden cursor-default fixed inset-0 bg-black bg-opacity-95 z-50 flex items-center justify-center">
    <span id="close-btn" class="absolute top-8 right-8 text-white text-4xl cursor-pointer hover:text-gray-300">&times;</span>
    
    {/* Flèche gauche */}
    <button id="prev-btn" class="absolute left-8 text-white text-5xl cursor-pointer hover:text-gray-300 p-4">
      &#8249;
    </button>
    
    <img id="lightbox-img" src="" alt="Image agrandie" class="max-w-3xl max-h-[70vh] object-contain" />
    
    {/* Flèche droite */}
    <button id="next-btn" class="absolute right-8 text-white text-5xl cursor-pointer hover:text-gray-300 p-4">
      &#8250;
    </button>
  </div>

  <script>
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    const galleryItems = document.querySelectorAll('.gallery-item img');
    const closeBtn = document.getElementById('close-btn');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    let currentIndex = 0;
    const images = Array.from(galleryItems).map(img => img.src);

    // Fonction pour afficher une image
    function showImage(index) {
      if (lightboxImg) {
        lightboxImg.src = images[index];
        currentIndex = index;
      }
    }

    // Ouvrir la lightbox au clic sur une image
    galleryItems.forEach((img, index) => {
      img.addEventListener('click', () => {
        if (lightbox) {
          showImage(index);
          lightbox.classList.remove('hidden');
        }
      });
    });

    // Navigation avec les flèches
    if (prevBtn) {
      prevBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const newIndex = (currentIndex - 1 + images.length) % images.length;
        showImage(newIndex);
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const newIndex = (currentIndex + 1) % images.length;
        showImage(newIndex);
      });
    }

    // Navigation au clavier
    document.addEventListener('keydown', (e) => {
      if (!lightbox?.classList.contains('hidden')) {
        if (e.key === 'ArrowLeft') {
          const newIndex = (currentIndex - 1 + images.length) % images.length;
          showImage(newIndex);
        } else if (e.key === 'ArrowRight') {
          const newIndex = (currentIndex + 1) % images.length;
          showImage(newIndex);
        } else if (e.key === 'Escape') {
          lightbox.classList.add('hidden');
        }
      }
    });

    // Fermer la lightbox
    if (closeBtn && lightbox) {
      closeBtn.addEventListener('click', () => {
        lightbox.classList.add('hidden');
      });

      lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) {
          lightbox.classList.add('hidden');
        }
      });
    }
  </script>

  {/* Texte de fin */}
  {record.txtfin && (
    <div class="w-full px-20 pb-10 flex justify-center">
      <p class="text-black text-[16px] bg-white p-4 border-[5px] border-white max-w-3xl whitespace-pre-wrap" style="font-family: 'Cal Sans', sans-serif; outline: 5px solid black;">{record.txtfin}</p>
    </div>
  )}

  {/* Image finale pleine largeur */}
  <div class="w-full">
    <img 
      src={imagefUrl} 
      alt="Image finale"
      class="w-full h-auto object-cover"
    />
  </div>
</Layout>
