---
import Layout from "../layouts/Layout.astro";
import PocketBase from "pocketbase";
import CardProjets from "../components/CardProjets.astro";
import fond2 from "../assets/fond2.webp";

const pbUrl = import.meta.env.PUBLIC_PB_URL;
if (!pbUrl) {
  throw new Error(
    "PUBLIC_PB_URL manquant. Ajoute PUBLIC_PB_URL dans .env et redémarre le serveur.",
  );
}
const pb = new PocketBase(pbUrl);

const res = await pb.collection("card_p_projets").getList(1, 500, {
  sort: "created",
});

const items = res.items.map((r) => ({
  record: r,
  imgUrl: r.img ? pb.files.getUrl(r, r.img) : "",
}));

function normalizeCategories(val: unknown): string[] {
  if (Array.isArray(val)) return val.filter(Boolean);
  if (typeof val === "string" && val.trim() !== "") return [val];
  return [];
}

const mapByCat = new Map<string, { record: any; imgUrl: string }[]>();
for (const it of items) {
  const cats = normalizeCategories(it.record.categorie);
  if (cats.length === 0) {
    const key = "Sans catégorie";
    mapByCat.set(key, [...(mapByCat.get(key) ?? []), it]);
  } else {
    for (const c of cats) {
      mapByCat.set(c, [...(mapByCat.get(c) ?? []), it]);
    }
  }
}

const allCats = Array.from(mapByCat.keys()).sort((a, b) => {
  if (a === "Sans catégorie") return 1;
  if (b === "Sans catégorie") return -1;
  return a.localeCompare(b);
});

function slugifyCat(cat: string) {
  return cat
    .toString()
    .trim()
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/&/g, "et")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

const slugCounts = new Map<string, number>();
function uniqueSlug(cat: string) {
  const base = slugifyCat(cat || "sans-categorie");
  const n = (slugCounts.get(base) || 0) + 1;
  slugCounts.set(base, n);
  return n === 1 ? base : `${base}-${n}`;
}

const catToSlug = Object.fromEntries(allCats.map((c) => [c, uniqueSlug(c)]));
---

<body style={`background-image: url('${fond2.src}'); overflow-x: hidden;`}>
  <Layout>
    <!-- Styles scrollbar horizontale fine + masquage débordement -->
    <style is:global>
      html,
      body {
        overflow-x: hidden;
        max-width: 100vw;
      }

      /* Firefox */
      .carousel-scroll {
        scrollbar-width: thin;
        scrollbar-color: rgb(255, 255, 255) transparent;
      }

      /* Webkit (Chrome, Safari, Edge) */
      .carousel-scroll::-webkit-scrollbar {
        height: 6px;
        background: transparent;
      }
      .carousel-scroll::-webkit-scrollbar-track {
        background: rgb(255, 255, 255);
        border-radius: 0; /* pas de radius */
        margin-inline: 246px; /* limite la largeur à la zone de contenu */
      }
      .carousel-scroll::-webkit-scrollbar-thumb {
        background: rgb(255, 255, 255);
        border-radius: 0; /* pas de radius */
        transition: background 0.2s;
      }
      .carousel-scroll::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.6);
      }
      /* Supprime les boutons/flèches */
    </style>

    <!-- Barre d'ancres catégories -->
    <section class="max-w-7xl mx-auto px-4 mt-34 mb-8">
      <div class="flex flex-wrap gap-3">
        <a
          href="#all"
          class="px-3 py-1 rounded-full border border-white !text-white hover:bg-white/20 transition"
          style="font-family:'Cal Sans'">Toutes</a
        >

        {
          allCats.map((cat) => (
            <a
              href={`#${catToSlug[cat]}`}
              class="px-3 py-1 rounded-full border border-white !text-white hover:bg-white/20 transition"
              style="font-family:'Cal Sans'"
            >
              {cat}
            </a>
          ))
        }
      </div>
    </section>

    <!-- Section carousels -->
    <section id="all" class="mx-auto max-w-full overflow-hidden space-y-14">
      {
        allCats.map((cat, catIndex) => {
          const list = mapByCat.get(cat) ?? [];
          const id = catToSlug[cat];
          return (
            <div id={id} class="scroll-mt-28">
              <h2
                class="mb-4 pl-9 text-white"
                style="font-family: 'Climate Crisis', system-ui, sans-serif; font-size: 28px; letter-spacing: .5px;"
              >
                {cat}
              </h2>

              <div class="relative mb-8">
                <div
                  class="carousel-scroll flex gap-6 overflow-x-auto snap-x snap-mandatory scroll-smooth
                   px-[246px] pb-4 pt-10 mb-3"
                  style="scroll-padding-inline: 246px;"
                >
                  {/* Carte statique THÉA - seulement dans la première catégorie */}
                  {catIndex === 0 && (
                    <div class="snap-center shrink-0 w-[468px] group">
                      <a href="/thea" class="block relative group-hover:z-20">
                        <div
                          class="will-change-transform transition-transform transition-[filter]
                           duration-150 ease-[cubic-bezier(.2,.8,.2,1)]
                           group-hover:duration-250 group-hover:ease-[cubic-bezier(.16,1,.3,1)]
                           group-active:scale-[0.995] group-hover:scale-[1.06] group-hover:brightness-110"
                        >
                          <div class="flex sm:flex-row items-start gap-6">
                            <div class="relative bg-white overflow-hidden shadow-sm w-[468px] min-w-[468px] max-w-[468px] flex-none">
                              <div class="p-3">
                                <div class="relative">
                                  <div class="aspect-[468/328] w-full overflow-hidden">
                                    <img
                                      src="src/assets/card/thea.webp"
                                      alt="THÉA"
                                      class="w-full h-full object-cover"
                                      loading="lazy"
                                    />
                                  </div>

                                  <div class="absolute top-3 right-4 ml-2">
                                    <span class="font-[ClimateCrisis] text-[22px] tracking-tight text-white text-outline">
                                      Collection / Galerie Photo
                                    </span>
                                  </div>
                                  <div class="absolute bottom-3 left-4">
                                    <span class="font-[ClimateCrisis] text-[22px] tracking-tight text-white text-outline">
                                      08/2025
                                    </span>
                                  </div>
                                </div>

                                <div class="w-full mt-3 sm:text-right">
                                  <h3 class="font-[ClimateCrisis] text-[38px] sm:text-[34px] leading-none mt-1">
                                    THÉA
                                  </h3>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </a>
                    </div>
                  )}

                  {/* Cartes dynamiques */}
                  {list.map(({ record, imgUrl }, i) => (
                    <div class="snap-center shrink-0 w-[468px] group">
                      <div class="relative group-hover:z-20">
                        <div
                          class="will-change-transform transition-transform transition-[filter]
                           duration-150 ease-[cubic-bezier(.2,.8,.2,1)]
                           group-hover:duration-250 group-hover:ease-[cubic-bezier(.16,1,.3,1)]
                           group-active:scale-[0.995] group-hover:scale-[1.06] group-hover:brightness-110"
                        >
                          <CardProjets
                            record={record}
                            imgUrl={imgUrl}
                            align={i % 2 === 0 ? "left" : "right"}
                          />
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          );
        })
      }
    </section>

    <style>
      .font-\[ClimateCrisis\] {
        font-family: "Climate Crisis", system-ui, sans-serif;
      }

      .text-outline {
        text-shadow:
          -1px -1px 0 rgba(0, 0, 0, 0.6),
          1px -1px 0 rgba(0, 0, 0, 0.6),
          -1px 1px 0 rgba(0, 0, 0, 0.6),
          1px 1px 0 rgba(0, 0, 0, 0.6);
      }
    </style>

    <!-- Flèche gauche -->
    <button
      class="carousel-btn left absolute left-0 top-1/2 -translate-y-1/2 hidden sm:flex items-center justify-center
                   h-14 w-14 text-white/90 hover:text-white transition-colors z-[9999] pointer-events-auto"
      aria-label="Précédent"
      onclick="
              const root = this.closest('.relative');
              const scroller = root?.querySelector('.carousel-scroll');
              if (scroller) scroller.scrollBy({ left: -492, behavior: 'smooth' });
            "
    >
      <svg
        width="36"
        height="36"
        viewBox="0 0 48 48"
        fill="none"
        aria-hidden="true"
      >
        <path
          d="M30 10 L18 24 L30 38"
          stroke="currentColor"
          stroke-width="6"
          stroke-linecap="round"
          stroke-linejoin="round"></path>
      </svg>
    </button>

    <!-- Flèche droite -->
    <button
      class="carousel-btn right absolute right-0 top-1/2 -translate-y-1/2 hidden sm:flex items-center justify-center
                   h-14 w-14 text-white/90 hover:text-white transition-colors z-[9999] pointer-events-auto"
      aria-label="Suivant"
      onclick="
              const root = this.closest('.relative');
              const scroller = root?.querySelector('.carousel-scroll');
              if (scroller) scroller.scrollBy({ left: 492, behavior: 'smooth' });
            "
    >
      <svg
        width="36"
        height="36"
        viewBox="0 0 48 48"
        fill="none"
        aria-hidden="true"
      >
        <path
          d="M18 10 L30 24 L18 38"
          stroke="currentColor"
          stroke-width="6"
          stroke-linecap="round"
          stroke-linejoin="round"></path>
      </svg>
    </button>
  </Layout>
</body>
); })}

<!-- Script ancres smooth + surbrillance active -->
<script type="module">
  // Scroll doux pour toutes les ancres internes
  document.querySelectorAll('a[href^="#"]').forEach((a) => {
    a.addEventListener("click", (e) => {
      const id = a.getAttribute("href")?.slice(1);
      const el = id ? document.getElementById(id) : null;
      if (!el) return;
      e.preventDefault();
      el.scrollIntoView({ behavior: "smooth", block: "start" });
      history.replaceState(null, "", `#${id}`);
    });
  });

  // Surbrillance de la puce active au scroll
  const chips = new Map();
  document.querySelectorAll('a[href^="#"]').forEach((chip) => {
    const href = chip.getAttribute("href") || "";
    const id = href.startsWith("#") ? href.slice(1) : "";
    if (id && id !== "all") chips.set(id, chip);
  });

  const observer = new IntersectionObserver(
    (entries) => {
      const visible = entries
        .filter((e) => e.isIntersecting)
        .sort((a, b) => b.intersectionRatio - a.intersectionRatio)[0];
      if (!visible) return;
      const id = visible.target.id;
      chips.forEach((chip, key) => {
        chip.classList.toggle("bg-black", key === id);
        chip.classList.toggle("text-white", key === id);
      });
    },
    { rootMargin: "-20% 0px -60% 0px", threshold: [0.2, 0.5, 0.8] },
  );

  document.querySelectorAll("[id]").forEach((sec) => {
    if (chips.has(sec.id)) observer.observe(sec);
  });
</script>

<!-- Script centrage initial des carousels -->
<script type="module">
  document.querySelectorAll(".carousel-scroll").forEach((scroller) => {
    requestAnimationFrame(() => {
      scroller.scrollTo({ left: 0, behavior: "auto" });
    });
  });
</script>
